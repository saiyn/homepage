---
layout: post
title:  "调试技术之GDB实战笔记"
date:   2017-11-21 15:15:54
categories: debug
excerpt: gdb linux debug
---

* content
{:toc}

相比于写代码，程序员需要花费更多的时间在调试代码上，调试自己新写的代码、调试别人出问题的代码、调试开源代码等等。gdb在调试程序方面的重要性不用多说，熟练
掌握使用gdb的基本功能可以解决很多问题；精通gdb的强大的高级功能可以极大的提高调试程序的效率。

网上关于gdb的文章铺天盖地，但是很多都是纸上谈兵，简单的罗列一些基本命令。本文从平时项目中遇到的实际问题出发，记录如何使用gdb的各种命令和功能，同时还有
gdb源码实现细节以及源码编译安装方面的问题记录。

<br />

---

# 源码编译GDB

<br />

根据gdb编译环境、运行环境以及运行模式的不同，编译前的配置和编译方式有较大不同。下面以常见的x86和hisi嵌入式平台为例，说明在编译服务器(x86架构)上的编译和配置命令。

* x86平台上，gdb以独立程序运行。

    配置命令：`--prefix=$HOME`

* hisi平台上，gdb以独立程序运行。

    配置命令: `--host=arm-hisiv300-linux --target=arm-hisiv300-linux --prefix=$HOME`

* hisi平台上，gdb以server模式运行在目标板上，gdb客户端运行在编译服务器上。

    先进入源码gdb文件夹内执行配置: `--host=x86_64-unknown-linux-gnu  --target=arm-hisiv300-linux --prefix=$HOME`
    
    然后进入gdb/gdbserver文件夹执行配置：`--host=arm-hisiv300-linux --target=arm-hisiv300-linux`



<br />

# 基本功能

<br />

## 查看源代码

<br />

gdb之所以能够知道对应的源代码，是因为调试版本的可执行程序中记录了源代码的位置信息。因为只是记录了源码的位置，所以如果
要让gdb打印出源码的话，显然需要gdb去某个目录中去寻找相应的.c文件才行。

默认情况下，gdb在编译时目录(`$cdir`)中去搜索，如果失败则在当前目录(`$cwd`)中去搜索。如果这两个目录都不方便存放我们的源代码，
我们可以通过`--directory`参数指定源代码的搜索位置，或者在运行时执行`directory`命令来动态添加搜索路径信息。

![gdb_0](http://omp8s6jms.bkt.clouddn.com/image/git/gdb_0.png)

----

# gdb的自动化脚本
  
<br />  
  
## 自动循环调用函数
  
<br />  
  
实际项目中应该会碰到这样的场景，你想测试某个接口函数的功能，或者是压力测试或者是简单的功能测试。为此，我们可以编写测试demo，但是如果这个接口函数依赖的其他库太多，编译这个demo是挺费事的话。这时gdb的自动化脚本的使用可以让事情变得非常简单轻松，尤其是需要进行压力测试时。

	#vo.script
	set pagination off
	set print thread-events off
	
	set $iter = 0
	set $cnt  = 0
	set $port = 0
	
	b dhssm_displaylink_platform.c:328
	comm
	silent
	set $port = ($iter / 2) % 3
	set $cnt = $cnt % 2
	printf "will put %s hdmi%d\n", $cnt == 0 ? "off" : "on", $port
	call VO_SwitchPort($port, $cnt)
	set $iter++
	set $cnt++
	c
	end
	
上面脚本主要实现的功能就是测试VO_SwitchPort()这个接口函数的功能，压力测试hdmi0~hdmi2开关功能。








	
	
