---
layout: post
title:  "ffmpeg笔记"
date:   2017-03-20 15:15:54
categories: ffmpeg
excerpt: ffmpeg linux note
---

* content
{:toc}


近一两年内开源项目中对我工作影响和帮助最大的非ffmpeg莫属，ffmpeg的强大以及被使用的普遍性令人惊讶。每次阅读ffmpeg的源代码都感觉收获颇多，经常将从ffmpeg里面吸收的代码技巧和音视频算法用于公司的实际项目中，解决实际问题的同时也提示自己的代码质量。感谢开源的精神与力量。


---

## ffserver

ffderver is a multimedia streaming server for live broadcasts. With it, you can streamover HTTP,RTP and RSTP.

![ffserver](https://www.alkannoide.com/wp-content/uploads/2013/07/ffserver_map.png)

### 配置文件

研究ffserver得从配置文件开始，doc/ffserver.conf 是配置文件的模板。ffserver　reads a configuration file containing global options and settings for each stream and feed.

主要的语法规则:
The configuration file consists of global options and dedicated sections, which must be introduced by "<SECTION_NAME ARGS>" on a separate line and must be terminated by a line in the form "</SECTION_NAME>". ARGS is a optional.

下面分别说明配置文件中的各个模块

**Feed section**

Feed 就是输入源的意思，这个配置模块就是告诉ffserver关于输入源的一些信息。比如这个输入源的名字，这个源数据量的大小，以及哪些地址的客户端可以接受这个源数据。You must use 'ffmpeg' to send a live feed to ffserver. In this example, you can type:ffmpeg http://localhost:8090/feed1.ffm. 第一种方式就是使用ffmpeg程序执行命令产生实时的数据流，比如执行`ffmpeg -i INPUTFILE http://localhost:8090/feed1.ffm`,其中`feed1.ffm`就是这个源的名字。ffserver can also do time shifting.It means that it can stream any previously recorded live stream.You must specify a path where the feed is stored on disk.You alsa specify the maximum size of the feed,where 0 means unlimited.第二种就是从硬盘中加载已经录制好的源，当然格式必须是.ffm的。这样我们可以写个feed配置块。

![feed1](http://omp8s6jms.bkt.clouddn.com/image/git/feed1.png)

**Stream section**

在说明stream配置模块前，先说明一下feed和stream的关系。A "live-stream" or "sream" is a resource published by ffserver,and made accessible through the HTTP protocol to cliens.	A stream can be connected to a feed, or to a file. In the first case, the published stream is forwarded from the corresponding feed generated by a running instance of ffpmeg.也就是说，stream是对feed的封装。Multiple streams can be connected to the same feed.下面是一个实例图:

![graph](http://omp8s6jms.bkt.clouddn.com/image/git/graph.png)

stream配置中主要包含三块内容，这个stream是对接的哪个feed；stream的格式;stream中的音视频码流参数。下面是ffserver目前支持的格式:

mpeg	|MPEG-1 multiplexed video and audio
mpegvideo	|only MPEG-1 video
mp2	|MPEG-2 audio(use AudioCodec to select layer 2 and 3 codec)
ogg	|ogg format(vorbis audio codec)
rm	|RealNetworks-compatible stream.Multiplexed audio and video.
ra	|RealNetworks-compatible stream.Audio only.
mpjpeg	|Multipart JPEG 
jpeg	|Generate a single JPEG image
mjpeg	|Generate a M_JPEG stream
asf	|ASF compatible streaming(Windows Media Player format)
swf	|Macromedia Flash compatible stream
avi	|AVI format(MPEG-4 video, MPEG audio sound)

下面是一个配置实例:

![stream2](http://omp8s6jms.bkt.clouddn.com/image/git/stream2.png)


最后，还要一个special stream.用来在网页上监控ffserver的状态信息。

![stream3](http://omp8s6jms.bkt.clouddn.com/image/git/stat.png)

This page will help us to moniter the server.This page is call with this url:http://localhost:8090/stat.html and you will get this page.执行如下的命令:

![ffser_cmd](http://omp8s6jms.bkt.clouddn.com/image/git/ffse_ffp.png)

得到如下的状态：

![status](http://omp8s6jms.bkt.clouddn.com/image/git/ffserver.png)




---


















