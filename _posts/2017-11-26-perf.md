---
layout: post
title:  "调试技术之perf实战笔记"
date:   2017-11-26 15:15:54
categories: debug
excerpt: perf linux debug
---

* content
{:toc}

做音视频中间件开发的，不可避免的会遇到各种性能问题。不同于一般的bug，性能问题往往比较隐蔽，如果不借助于工具，只能是通过代码逻辑去揣测、去
猜想问题的原因，然后就是无休止的尝试。除了解决已经遇到到的性能问题，我们在设计实现新架构代码时，或者是去优化重构别人代码时，我们怎样去证明我们
的架构、我们的优化时合理高效的。所以掌握软件性能分析的技术和工具使用是称为高水平程序员的必备条件，更应该是称为架构师的前提条件。

<br />

# Perf 简介

<br />

# 背景知识与基础

<br />

不同于gdb这样的调试工具，如果你不掌握足够软件性能相关的基础背景知识，即使你熟悉每一个perf工具的命令，你依然发挥不了perf的作用。

<br />

## 性能相关的处理器硬件特性

<br />

**cache**

<br />

内存读写是很快的，但还是无法和处理器的指令执行速度相比。为了从内存中读取指令和数据，处理器需要等待，用处理器的时间来衡量，这种等待很漫长。
cache的读写速度非常快，能和处理器速度匹配。因此将常用的数据保存在cache中，处理器便无须等待，从而提高性能。但是，cache的容量一般很小，充分
利用cache是软件调优非常重要的部分。这里说的硬件cache和linux内核中实现的cache机制是不同的，不能混淆。关于linux下的buffer/cache知识，见[这篇文章](https://linux.cn/article-7310-1.html).

<br />

**流水线、超标量体系、乱序执行**

<br />

提高性能最有效的方式之一就是并行。处理器在硬件设计上提高流水线、超标量体系以及乱序执行支持等技术来尽可能保证真正的指令并行。

处理器处理一条指令需要分多个步骤完成，比如先取指令，然后完成运算，最后将计算结果写回。在处理器内部，这就可以看作是一个三级流水线。
不同架构的处理器支持不同级数的流水线，比如arm9就支持了6级流水线，而intel架构的cpu一般支持三级流水线。流水线越多，表明一个时钟周期可以
同时处理的指令数越多。

超标量(superscalar)指一个时钟周期发射多条指令的流水线机器架构，比如Intel的Pentium处理器，内部有两个执行单元，在一个时钟周期内允许执行
两条指令。

此外，在处理器内部，不同指令所需要的处理器步骤和时钟周期是不同的，如果严格按照程序的执行顺序执行，那么就无法充分利用处理器的流水线。因此
指令有可能被乱序执行。

上述三种并行技术对所执行的指令有一个基本要求，即相邻的指令没有依赖关系。假如某条指令需要依赖前面的一条指令的执行结果数据，那么这些技术就
无法被利用。因此，在使用perf工具的stat命令时，有一个非常重要的统计指标就是IPC(instructions per cycle)，一般这个值大于1.0时，才表示程序
的执行效率是健康的。大神Brendan Gregg关于IPC的解释如下:

> IPC is a commonly examined metric, either IPC or its invert, CPI. Higher IPC values mean higher instrucion throughput,
> and lower values indicated more stall cycles. I'd generally interpert high IPC values(eg, over 1.0) as good, indicating 
> optimal processing of work. However, I'd want to double check what the instructions are, in case this is due to s spin
> loop: a high rate of instructions, but a low rate of actual work completed.

<br />

**分支预测**






