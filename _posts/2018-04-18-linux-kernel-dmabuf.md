---
layout: post
title:  "Linux内核笔记之DMA_BUF"
date:   2018-04-18 15:15:54
categories: Linux-Kernel
excerpt: linux kernel dma-buf gpu drm prime
---

* content
{:toc}


内存管理始终是底层软件的核心部分，尤其是对于音视频的解码显示功能。本文将通过编写一个实例驱动程序，同内核中的i915显卡驱动进行内存方面的交互来剖析
Linux内核中的通用子系统DMA_BUF。

---


# 驱动实例

<br />

## 需求背景

<br />

考虑这样一种场景，摄像头采集的视频数据需要送到GPU中进行编码、显示。负责数据采集和编码的模块是Linux下不同的驱动设备，将采集设备中的数据送到编码设备中
需要一种方法。最简单的方法可能就是进行一次内存拷贝，但是我们这里需要寻求一种免拷贝的通用方法。

实际的硬件环境是，采集设备是一个pciv驱动，编码设备就是i915驱动。现在就是要编写一个驱动程序，让i915驱动可以直接访问pciv中管理的视频数据内存。

<br />

## 驱动设计



---

<br />

# DMA_BUF

<br />

## 概述

<br />

**引入dma-buf机制的原因**

<br />

* 之前内核中缺少一个可以让不同设备、子系统之间进行内存共享的统一机制。

* 混乱的共享方法：

   * V4L2(video for Linux)使用`USERPTR`的机制来处理访问来自其他设备内存的问题，这个机制需要借助于以后空间的mmap方法。
   
   * 类似的，wayland和x11各自定义了客户端和主进程之间的内存共享机制，而且都没有实现不同设备间内存共享的机制。
   
   * 内核中各种soc厂商的驱动、各种框架和子系统都各自实现各自的内存共享机制。
  
* 之前共享方式存在问题：

  * 使用用户层的mmap机制实现内存共享方式太过简单粗暴，难以移植。
  * 没有统一的内存共享的API接口。


---

<br />







[dma_buf文档](https://elinux.org/images/a/a8/DMA_Buffer_Sharing-_An_Introduction.pdf)





